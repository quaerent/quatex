\usepackage{mathtools}
\usepackage{scalerel}
\usepackage[extdef]{delimset}

%% Fix spacing of `\left( .. \middle| .. \right)'
\NewCommandCopy{\leftold}{\left}
\NewCommandCopy{\rightold}{\right}
\NewCommandCopy{\middleold}{\middle}
\renewcommand*{\left}{\mathopen{}\mathclose\bgroup\leftold}
\renewcommand*{\right}{\aftergroup\egroup\rightold}
\RenewDocumentCommand{\middle}{sm}
  {\IfBooleanTF{#1}{\.\middleold#2\.}{\mathrel{}\middleold#2\mathrel{}}}
\NewDocumentCommand{\innermiddle}{m}
  {\mathinner{}\middleold#1\mathinner{}}

((* if define_custom_math_commands *))
%% Use more direct name for common math operators
\newcommand*{\union}{\cup}
\newcommand*{\inter}{\cap}
\newcommand*{\Union}{\bigcup}
\newcommand*{\Inter}{\bigcap}
\newcommand*{\disunion}{\sqcup}
\newcommand*{\Disunion}{\bigsqcup}
\newcommand*{\tensprod}{\otimes}
\newcommand*{\directsum}{\oplus}
\newcommand*{\Tensprod}{\bigotimes}
\newcommand*{\Directsum}{\bigoplus}
% Use starred version for left arrows
\NewDocumentCommand{\mapinto}{s}
  {\IfBooleanTF{#1}{\hookleftarrow}{\hookrightarrow}}
\NewDocumentCommand{\maponto}{s}
  {\IfBooleanTF{#1}{\twoheadleftarrow}{\twoheadrightarrow}}

%% Helper macros
\NewDocumentCommand{\raisemath}{m}
  {\mathpalette{\raisemathAux{#1}}}
\NewDocumentCommand{\raisemathAux}{m m m}
  {\raisebox{#1}{\(#2#3\)}}
\NewDocumentCommand{\scalemath}{m O{}}
  {\mathpalette{\scalemathAux{#1}[#2]}}
\NewDocumentCommand{\scalemathAux}{m O{} m m}
  {\IfBlankTF{#2}{\scalebox{#1}{\(#3#4\)}}{\scalebox{#1}[#2]{\(#3#4\)}}}

%% Quotient
%%   #1 - raise amount for numerator (default: 0.2)
%%   #2 - negative space amount before slash (default: 1.7)
%%   #3 - numerator
%%   #4 - denominator
\NewDocumentCommand{\quotient}{O{0.2} O{1.7} m m}{
    \left.\mspace{-1mu}\raisemath{#1em}{#3}
    \mspace{-#2mu} \middle/ \mspace{-\fpeval{#2+1}mu}
    \raisemath{-#1em}{#4} \mspace{-\fpeval{5*#1}mu} \right.
}

%% Sizeable bullet
\NewDocumentCommand{\sbullet}{O{0.5}}{%
    \mathbin{%
        \ThisStyle{%
            \vcenter{%
                \hbox{%
                    \scalebox{#1}{%
                        \(\SavedStyle\bullet\)%
                    }%
                }%
            }%
        }%
    }%
}
\NewDocumentCommand{\fdot}{}
  {\mathcolor{black!80}{\sbullet[0.65]}}
\NewDocumentCommand{\adot}{}
  {\sbullet[0.52]}
\NewDocumentCommand{\idot}{s}
  {\mathcolor{darkgray}{\IfBooleanTF{#1}{\.\sbullet[0.4]\.}{\sbullet[0.4]}}}

%% (abstract) index placeholders
\NewDocumentCommand{\aind}{}{\bullet}
\NewDocumentCommand{\dind}{}{\mathcolor{black!60}{\sbullet[1.2]}}
\NewDocumentCommand{\ind}{}{\mathcolor{lightgray}{\bullet}}

%% Argument placeholder
\newsavebox{\argumentbox}
\sbox{\argumentbox}{%
    \begin{tikzpicture}[baseline=-0.6ex]
        \node(char)[
            draw,
            shape=rectangle,
            dash=on 1.2pt off 1.05pt phase 0.5pt,
            dash expand off,
            inner ysep=2pt,
            inner xsep=2pt,
            minimum size=0.6em,
            rounded corners=2pt
        ] {};
    \end{tikzpicture}%
}
\NewDocumentCommand{\argument}{o}{% with optional scaling factor
    \IfValueTF{#1}{%
        \scalebox{#1}{\resizebox{!}{0.58em}{\usebox{\argumentbox}}}
    }{%
        \mathchoice
            {\argument[1.0]}% display
            {\argument[1.0]}% text
            {\argument[0.7]}% script
            {\argument[0.6]}% scriptscript
    }%
}

\ExplSyntaxOn

%% Math alphabets shortcuts
% mathbb
\clist_map_inline:nn { C, F, N, Q, R, Z }
  { \cs_new:cpn {#1} {\mathbb{#1}} }
% mathcal
\clist_map_inline:nn { C, D, I, J }
  { \cs_new:cpn {#1#1} {\mathcal{#1}} }
% mathscr
\clist_map_inline:nn { B, F, G }
  { \cs_new:cpn {#1#1} {\mathscr{#1}} }
% mathfrak
\clist_map_inline:nn { b, c, m, P, Q, p, q }
  { \cs_new:cpn {#1#1} {\mathfrak{#1}} }
\newcommand*{\aaa}{\mathfrak{a}} % `\aa` is reserved in LaTeX

%% Lie groups and algebras shortcuts
\let\sl\relax % avoid conflict with `sl` command (which is deprecated)
\clist_map_inline:nn { GL, SL, SO, U, SU, PGL, PSL }
  { \cs_new:cpn {#1} {\mathsf{#1}} }
\clist_map_inline:nn { gl, sl, so, su }
  { \cs_new:cpn {#1} {\mathfrak{#1}} }
\newcommand*{\OO}{\mathsf{O}}   % `\O` is reserved in LaTeX
\newcommand*{\oo}{\mathfrak{o}} % `\o` is reserved in LaTeX

%% Other common operators
\DeclareMathOperator*{\colim}{colim} % colimit
\DeclareMathOperator{\Char}{char}    % `\char` is reserved in LaTeX
\clist_map_inline:nn {
  % linear algebra
  tr, adj, Span,
  % group theory
  Orb, Stab, Br,
  % number theory
  lcm, Gal, ab, sep, al, inv, disc, Res, Cor,
  % commutative algebra
  Tor, Ext, Ann, Ass, Frac, rank,
  % algebraic geometry
  Spec, Supp, Div,
  % lie algebra
  Lie, AD, Ad, ad,
  % category
  Ob, Mor, Hom, End, Aut, Fun, id, im, coim, coker, op,
  % infinite category
  Map, LLP, RLP, Ho, sk, cosk,
  % others
  sign, vol,
} { \expandafter\DeclareMathOperator\csname#1\endcsname{#1} }

\ExplSyntaxOff
((* endif *))
